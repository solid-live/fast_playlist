<!DOCTYPE html>
<html>
<head>
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!--Import materialize.css-->
  <!-- <link type="text/css" rel="stylesheet" href="css/materialize.css"/>-->
  <link rel="stylesheet" type="text/css" href="css/main.css"/>


  <script type="text/javascript" src="js/youtube.js"></script>
  <script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
  <script type="text/javascript" src="js/main.js"></script>

  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="png" href="./favicon.png">
</head>

<body class="cyan lighten-5">
  <div class="navbar-fixed">
    <nav>
      <div class="nav-wrapper red">
        <a class="brand-logo center" href="./">Youtube Solid Playlist</a>
      </div>
    </nav>
  </div>
  <div class="container">
    <div class="row">
      <div class="col s6">
        <div class="row">
          <div class="col s12 center"><div id="player"></div></div>
        </div>
        <div class="row">
          <div class="col s10 offset-s1 card white">
            <div class="input-field">
              <i onclick="searchVid($('#search').val())" class="material-icons prefix" style="cursor: pointer">search</i>
              <input id="search" type="search" style="padding-left: 2rem; width: calc(90% - 2.5rem)"></input>
              <label for="search">Search Youtube</label>
            </div>
          </div>
        </div>
        <ul class="collection" id="search_res">
        </ul>
      </div>

      <div class="col s5">
        <ul class="collection" id="suggestions">
        </ul>
        <div class="row card white">
          <div class="col s3 center waves-effect btn-play-control" onclick="playPrev()">
            <i class="material-icons small" title="Previous">skip_previous</i>
          </div>
          <div class="col s3 center waves-effect btn-play-control" onclick="playNext()">
            <i class="material-icons small" title="Next">skip_next</i>
          </div>
          <div class="col s3 center dropdown-button btn-flat" data-activates="play_mode">
            <i id="play_selected" class="material-icons small" title="Dropdown to choose">trending_flat</i>
            <ul id="play_mode" class="dropdown-content">
              <li onclick="toggleRepeatMode('none')"><i class="material-icons small" title="Play all once">trending_flat</i></li>
              <li onclick="toggleRepeatMode('all')"><i class="material-icons small" title="Repeat All Songs">repeat</i></li>
              <li onclick="toggleRepeatMode('one')"><i class="material-icons small" title="Repeat One Song">repeat_one</i></li>
              <li onclick="toggleRepeatMode('shuffle')"><i class="material-icons small" title="Shuffle">shuffle</i></li>
            </ul>
          </div>
          <div id="share" class="col s3 center waves-effect btn-play-control" onclick="toggleShareLink()">
            <i class="material-icons small" title="View Share Link">share</i>
          </div>
        </div>
        <div class="row card white" id="share_link_box" style="opacity:0;">
          <div class="input-field col s12" style='height:0px'>
            <input value="dummy" id="share_link" type="text" readonly onclick="this.select()">
            <label class="active" for="share_link">Share Link</label>
          </div>
        </div>
        <ul class="collection" id="playlist">
        </ul>
      </div>
    </div>
  </div>

  <script type="text/javascript" src="js/materialize.min.js"></script>

  <script src="https://apis.google.com/js/client.js?onload=onGoogleApiClientLoad"></script>
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-76325610-1', 'auto');
      ga('send', 'pageview');
  </script>

  <script src="js/rdflib.js"></script>
  <script src="js/solid.js"></script>
  <script src="js/sha256.js"></script>
  <script src="js/notie.js"></script>
  <script>
  // 2. This code loads the IFrame Player API code asynchronously.
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  $("#search").keypress(function(e){
    var keycode = (e.keyCode ? e.keyCode : e.which);
    if(keycode == '13'){
      searchVid($(this).val());
    }

  })


  var Solid = require('solid');
  var storage;
  authEndpoint = 'https://databox.me/';
  var dologin = function() {
    // Get the current user
    Solid.auth.login(authEndpoint).then(function(webid){
      // authentication succeeded; do something with the WebID string
      notie.alert(1, 'Success!  You are logged in as : ' + webid);

      Solid.identity.getProfile(webid).then(function (parsedProfile) {
        console.log('getProfile result: %o', parsedProfile)
        console.log('Account storage root: %s', parsedProfile.externalResources.storage) // array of URIs })
        storage = parsedProfile.externalResources.storage[0];
        console.log(storage);
        var containerName = 'playlist/';

        var url = storage + containerName;
        Solid.web.get(url).then(
          function(response) {
            console.log('Raw resource: %s', response.raw())
          }
        ).catch(
          function(err) {
            console.log(err) // error object
            // ...
            var parentDir = 'https://example.org/'
            var slug = 'playlist'
            var data = '<#this> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://rdfs.org/sioc/ns#Space> .'
            var isContainer = true

            Solid.web.post(storage, data, slug, true).then(
              function(solidResponse) {
                console.log(solidResponse)
                // The resulting object has several useful properties.
                // See lib/solid-response.js for details
                // solidResponse.url - value of the Location header
                // solidResponse.acl - url of acl resource
                // solidResponse.meta - url of meta resource
              }
            ).catch(function(err){
              console.log(err) // error object
              console.log(err.status) // contains the error status
              console.log(err.xhr) // contains the xhr object
            })

          }
        )


      });

      window.user = webid;
    }).catch(function(err) {
      // authentication failed; display some error message
      alert(err);
    });
  };



  function savePlaylist(code, name){

    function putFile(file, data) {
      var xhr = new XMLHttpRequest();
      xhr.open('PUT', file, false);
      xhr.setRequestHeader('Content-Type', 'text/plain; charset=UTF-8');
      xhr.send(data);
      notie.alert(1, file + ' saved successfully!', 1.5);
    }

    var file = 'default.txt';

    if (window.user) {
      var data = ''
      for (var i = 0; i < playlist.length; i++) {
        var p = playlist[i]
        var vid = "https://www.youtube.com/watch?v=" + p.id.videoId
        data += '<> <http://www.w3.org/ns/ldp#contains> "'+ vid +'" .\n'
        data += '<' + vid + '> <http://www.w3.org/ns/posix/stat#mtime> ' + i + ' .\n'
      }
      console.log(data)

      var file = notie.input('Please enter name of file to save ', 'Submit', 'Cancel', 'filename', 'playlist.ttl', function(file) {

        var target =
        Solid.web.put(storage + 'playlist/' + file, data, 'text/turtle').then(
          function (meta) {
            console.log(meta.xhr.status) // HTTP 200 (OK)
            notie.alert(1, file + ' saved successfully!', 1.5);
          }
        ).catch(function(err){
          console.log(err) // error object
        })

      })

    }

  }


  document.addEventListener('keydown', function(e) {
    if(e.keyCode == 76 && (e.ctrlKey || e.metaKey)) {

      e.shiftKey ? showLogin() : dologin()

      e.preventDefault()
      return false
    }

    if(e.keyCode == 83 && (e.ctrlKey || e.metaKey)) {
      console.log('saving')
      e.shiftKey ? showMenu() : savePlaylist()

      e.preventDefault()
      return false
    }

  })

  </script>
</body>
</html>
